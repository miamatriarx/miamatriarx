---
name: Release
concurrency:
  group: ${{github.ref}}
  cancel-in-progress: true
on:
  push:
    tags: '*'
  workflow_dispatch:
jobs:
  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Analyze
        uses: actions/dependency-review-action@v2
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Lint
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: true
  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Analyze
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{secrets.SONAR_TOKEN}}
        with:
          args:
            -Dsonar.organization=miamatriarx
            -Dsonar.projectKey=miamatriarx_miamatriarx
            -Dsonar.projectBaseDir=.
            -Dsonar.sources=.
            -Dsonar.tests=tests
            -Dsonar.verbose=true
  deploy:
    needs:
      - dependency-review
      - code-review
      - code-analysis
    name: Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      PROJECT_ID: PROJECT_ID
      GAR_LOCATION: GAR_LOCATION
      SERVICE: SERVICE_NAME
      REGION: SERVICE_REGION
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Google Auth
        id: google-auth
        uses: google-github-actions/auth@v0
        with:
          token_format: access_token
          workload_identity_provider: ${{secrets.WIF_PROVIDER}}
          service_account: ${{secrets.WIF_SERVICE_ACCOUNT}}
      - name: Docker Auth
        id: docker-auth
        uses: docker/login-action@v1
        with:
          username: oauth2accesstoken
          password: ${{steps.auth.outputs.access_token}}
          registry: ${{env.GAR_LOCATION}}-docker.pkg.dev
      - name: Build
        run: |
          docker build -t "${{env.GAR_LOCATION}}-docker.pkg.dev/${{env.PROJECT_ID}}/${{env.SERVICE}}:${{github.sha}}" .
          docker push "${{env.GAR_LOCATION}}-docker.pkg.dev/${{env.PROJECT_ID}}/${{env.SERVICE}}:${{github.sha}}"
      - name: Deploy
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v0
        with:
          service: ${{env.SERVICE}}
          region: ${{env.REGION}}
          image: ${{env.GAR_LOCATION}}-docker.pkg.dev/${{env.PROJECT_ID}}/${{env.SERVICE}}:${{github.sha}}
      - name: Finalize
        run: echo ${{steps.deploy.outputs.url}}
